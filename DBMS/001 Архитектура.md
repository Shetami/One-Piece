![[Pasted image 20240623231533.png]]
[[001.1.Фоновые (красные)]]

Синие - процессы, напрямую не относящиеся к постгресу. То, откуда выполняем запрсоы.

Красные - процессы, какие то не взаимодействуют с клиентом. Слева снизу - фоновые бд.

Желтые - буферы памяти
- Shared buffers - хранилище в основной памяти, хуярим туда страницу. Чтобы не обращаться во внешнюю память постоянно (к внешней долгое обращение) и потом уже периодически синхронизировать с внешней.
  Все процессы могут туда обращаться.
    - По умолчания 128 мб
- Lock - хранилище для временных блокировок.  
- WAL buffer (write, ahead, lock) - хранится информация об изменении данных (XLOG), пока не записаны во внешний файл. Обеспечивает #durability (долговечность). Нужна чтобы восстановить данные.
    - При изменении страницы данные хранятся в оперативке (shared buffers), такие страницы называются грязными (не синхронизированные с данными на вторичке). Если чёто отъебнёт то оперативка дропнится до синхронизации (durability отсутствует). Чтобы такой хуйни не было есть WAL. Данные об операции (добавили такие то данные) будут сохранены на WAL и перед коммитом данные будут сохранены в WAL файл на диск. При восстановлении бд будут найдены точки синхронизации и всё из WAL будет повторено и это и есть durability (из ACID).
    - Любые изменения транзакции фиксируются в в WAL.
      Данные что транзакция происходит фиксируется в **WALL-buffer** (добавили данные в такие таблицы) и **перед** коммитом (изменения будут именно в shared buffers) **WALL-buffer** сохраняется в **WAL-файлы**. Если отъебнёт сервак до того, как **shared-buffers** сихнронизируется со вторичной (**файлами данных**), изменения уже будут сохранены в **WAL-файлах**.
      
      При этом тут **wal writer** тоже принимает участие. Переодически скидывает с **WAL-буферов** в **WAL-файлы**
    - WAL буфер также хранит данные чекпоитов (контрольные точки) и завершения транзакций.
    - Изменениям присваиваются LSN (номер изменения).
    - Один на кластер баз данных.
    - WAL-файлы- журнал. Записывается после контрольной точки
    - По принятию запросов - записывает их в WAL-файлы в **pg_wal_archive_status**. Когда WAL-файл переполняется - переиминует в **.ready** или **.done** и процесс **archiver** может этот WAL-файл куда-то заархифировать.
- GLOG (commit lock buffer) - фиксируется статус транзакции (идёт или завершилась или ещё что)

# Процессы
У процессов есть также своя память 

#### Виды процессов
- Клиентско-пользовательские - клиенты пытаются подключиться к субд (постгрес)
- серверные субд
    - серверный пользовательский процесс - обрабатывать запросы пользователя.
	    - Выделяется своя память - по умолчанию 4 mb![[Pasted image 20240624003443.png]]
    - Фоновые - действия поддержки функций субд

#### Виды подключения
- Выделенный сервер
    - Юзер пытается сделать коммит - субд слушает входящие запросы и создаёт отдельный серверный процесс для клиента (после проверки аутенфикации). Характерно для постгреса
    - Из минусов - процессы дорогая хуйня и большое количество пользователей забираем бля ресурсов дохуя
![[Pasted image 20240623232938.png]]
- Разделяемый
    - Может выделять определённый пул процессов и работает через диспетчера через очередь.
    - Снижает отзывчивость тк нужно бля ждать пока освободится процесс.
    - В постгресе нет такого режима напрямую.

    ![[Pasted image 20240623233424.png]]
##### Connection Pool
хуйня которая есть в постгресе и можно досчить чего то похожего на разделяемый сервер за счёт пула соединений, который балансирует всю хуйню
- pgBouncer
- pgpool-ll
![[Pasted image 20240623233526.png]]