- Установка
    Базовые компонетны PostgreSQL
    - сервер (postgresql)
    - клиент (postgresql-client)
    - contrib, doct и другие вспомогательные вещи
    - установка (сборка) базовых компонентов
        - sudo apt install postgresql -XX postgresql client-XX
        - 
    - Подготовка для кластера
        - adduser postgres
        - mkdir [PGDATA] -папка в которой будет располагаться кластер, все файлы свзанные с бд
        - chown postgres [PGDATA] - права
        
    - Задание переменных окружения PGDATA с её путём которую ранее создали, ..
        - Заранее установить: export PGDATA = [PGDATA]
            postgres
        - PGDATA должна быть проинициализирована перед запуском PostgreSQL
            
    - Также все утилиты расположены в [path..]/bin так что это можно тоже добавить в PATH. export PATH=/home/student/pgsql13/bin/PATH
        
    - Чтобы бд начала работать нужно инициализировать базовые файлы. Делается с помощью файла initdb
        - [/pg_path]/bin/initdb [-D PGDATA_path](можно не указывать если установили переменные окружения) - создаёт конфигурационные файлы. [-U postgres] указание имени суепрпользователя
        
    - Запуск экземпляра кластера БД. Запустить postgres/pg_ctl (использует postgres, ей лугче управлять, работает в фоне)
        - i./[/pg_path]/bin/pg_ctl [-D PGDATA_path]
        - ii./[/pg_path]/bin [-D PGDATA_path] -l logfile start
    
    Инициализация кластера с помощью -initdb
    
    - Создаёт структуру директорий внутри PGDATA
    - Создаёт стандартные БД, для создания своих бд
    - Задаёт локаль и кодировку, которая будет использоваться кластермо БД
    
    initdb [-D PGDATA_path] либо pg_ctl initdb (ключ -D). Один из двух вариков
    
    Что будет теперь:
    
    - БД postgres - точка старта. Принадлежит администратору БД (которого сверху создали)
    - template1, template0 - клон первого (самое главное предназначение - восстановить template1)
        - Своя бд в качестве шаблона
        - Если внести изменения бд template1 они также будут внесены и в ьд, созданных на его основе
        - к template0 нельщя подключиться (резервная)
    - initdb также создаёт супервользователя, по умолчанию совпадает с именем пользователя который запустил initdb
        - можно задать -U: initdb -U name
    
    **Запуск сервера бд**
    - [/pg_path]/bin/postgreses [-D PGDATA_path]
    
    PGDATA должна быть проинициализирована перед запуском сервера
    
    Утилита pg_ctl
    
    - дл упрощения взаимодействия с postgres
    - запускаь (по умолчаию в фоне), останавливать, перезапускать кластер
        - pg_stl start -l logfile
        - pg_ctl status [-D PGDATA_path]
        - pg_ctl [-D PGDATA_path] initdb - инициализация

- Подключение
    
    Клиенты для взаимодействия - клиенты:
    
    psql
    
    pgAdmin - графический интерфейс
    
    Пользователь и роль с параметром login - одно и тоже
    
    Для подключения роли:
    
    - LOGIN
    - привелегия CONNECT на нужную бд
    - разрешение в pg_hba.conf (прописываются разрешения для подключения к кластеру бд)
- pg_hba.conf
    
    Создаётся по команде initdb
    
    В директории PGDATA
    
    с помощью hba_file можно поменять
    
    pg_hba.conf - конфигурация подключений
    
    Порядок расположения записей влияет на права
    
    Если что-то в нем изменили то нужно чтобы постгрес подхватил изменения для этого:
    
    `pg_reload_conf()` - перезагрузить, rg_ctl reload - перезагрузить сам постгрес
    
    Пример pg_hba.conf
    
    ```sql
    	# local DATABASE USER METHOD [OPTIONS]
    	# host  DATABASE USER ADRESS METHOD [OPTIONS]
    ```
    
    Есть разные виды подключений - базовый local, host.
    
    - local
        - подключение с той же системы где установлен постгрес
        - подключение через psql - хост не нужен
    - host
        - TCP/IP
        - подключение - указывает хост и порт
            - psql - h host -p database
            - psql -h host -p post -U username
    
    Методы подключения
    
    - trust - все блять смогут подключиться (mtrhod в pg_hba.conf)
    - по паролю
    
    ![[Pasted image 20240624012257.png]]
    
- Создание бд
    
    По умолчанию для создания испльзуется шаблн template1
    
    можно указать свой
    
    ```sql
    CREATE DATABASE newDb3 TEMPLATE template_my;
    createdb -T template_my newDB2
    ```
    
    Если создавать от своих темплейтов, то важно понимать что не должно быть других подключений, тк нельзя будет создать тогда
    
    Чтобы запретить подключения:
    
    От системного каталога pg_database
    
    datallowconn - запретить
    
    datistemplate - бд, созданная чтобы быть шаблоном, чтобыт использоваться владельцем, суперuser и user with CREATEDB.
    
- Файловая структура и конфигурация PostgreSQL после инициализации
    
    - PGDATA - конфигурационные файлы также тут
        - pg_hba.conf…
        - набор стандартных директорий для любого кластера
            - global - таблицы урвоня кластера (pg_database)
            - pg_wal
            - pg_xact - с коммитами транзакций
            - base - файлы данных базы данных. Изначально содержит бд postgres, template1, template0
- Базовые Конфигурационные файлы
    
    - путь /etc/posgresql/версия/main/
    - postgresql.conf - самый важный, здесь хранятся настройки базы. Правила в нём действуют для всех бд в кластере
    - postgresql.auto.conf - настройки можно задавать через ALTER SYSTEM, после их применения помещаются в postgresql.auto.conf
    - pg_hba.conf - конфигурируем подключения
    - pg_ident.conf - отобразить имена куда можно задать правила для определённых видов подключений
    
    Изменение конфигурационных параметров:
    
    - `postgresql.conf`/`ALTER SYSTEM` - для всех
    - ALTER DATABASE - для конкретной бд. Для данной бд переписывает то что указано в `postgresql.conf`
    - ALTER ROLE
    - SET - Изменить параметры в рамках сессии.
    - Параметры можно задать в команде запуска сервера бд - перезаписать `postgresql.conf`